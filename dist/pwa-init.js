import{apiModel}from"../src/models/apiModel.js";import{favoriteDB}from"../src/db/favorite-db.js";let deferredPrompt;"serviceWorker"in navigator&&navigator.serviceWorker.register("/sw.js").then(()=>console.log("‚úÖ Service Worker terdaftar")).catch(e=>console.error("‚ùå SW gagal:",e)),window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e;const r=document.createElement("button");r.textContent="üì± Install Aplikasi",r.classList.add("install-btn"),document.body.appendChild(r),r.addEventListener("click",async()=>{r.style.display="none",deferredPrompt.prompt();const{outcome:e}=await deferredPrompt.userChoice;console.log(`User choice: ${e}`),deferredPrompt=null})}),window.addEventListener("online",async()=>{apiModel.isLoggedIn()&&await favoriteDB.syncOfflineStories(apiModel)});const VAPID_PUBLIC_KEY="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";export const pushManager={async subscribe(){if(!("serviceWorker"in navigator)||!("PushManager"in window))return console.warn("Push notifications not supported"),!1;try{const e=await navigator.serviceWorker.ready,r=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(VAPID_PUBLIC_KEY)});return(await apiModel.subscribeWebPush(r.toJSON())).error?(console.error("‚ùå Failed to register subscription on server"),await r.unsubscribe(),!1):(console.log("‚úÖ Push subscription berhasil:",r),localStorage.setItem("pushSubscription",JSON.stringify(r)),!0)}catch(e){return console.error("‚ùå Push subscription gagal:",e),!1}},async unsubscribe(){try{const e=await navigator.serviceWorker.ready,r=await e.pushManager.getSubscription();if(r){return(await apiModel.unsubscribeWebPush(r.toJSON())).error&&console.error("‚ùå Failed to unregister subscription on server"),await r.unsubscribe(),console.log("‚úÖ Push subscription dibatalkan"),localStorage.removeItem("pushSubscription"),!0}}catch(e){console.error("‚ùå Unsubscribe gagal:",e)}return!1},async isSubscribed(){try{const e=await navigator.serviceWorker.ready;return!!await e.pushManager.getSubscription()}catch{return!1}},urlBase64ToUint8Array(e){const r=(e+"=".repeat((4-e.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(r),o=new Uint8Array(t.length);for(let e=0;e<t.length;++e)o[e]=t.charCodeAt(e);return o}};